 <!-- Main content -->
    <div class="content">
      <div class="container-fluid">
        <div class="row">          
          <!-- /.col-md-12 -->
          <div class="col-lg-12"> 			
			<!-- Main content -->
				<div class="content">
				  <div class="container-fluid">
					<div class="row">          
					  <!-- /.col-md-12 -->
					  <div class="col-lg-12">           

						<div class="card card-info card-outline">
						  <div class="card-header ">
							<h5 class="m-0 card-title">Condonation  Approval</h5>
							
						  </div>
						  <div class="card-body ">
						  <form id="formCondonationList">
							<div class="row">
									<div class="col-md-3">
											<div class="form-group">
											   <label for="program">Program</label>
											   <select class="form-control" id="selectProgram" name="program" required>
													<option>Select Program</option>	
												</select>
											</div>
										</div>
										<div class="col-md-3">
											<div class="form-group">
											   <label for="batch">Batch</label>
											   <select class="form-control" id="selectBatch" name="batch" required>
													  <option>Select Batch</option>							  
												</select>
											</div>
										</div>
										<div class="col-md-3">
											<div class="form-group">
											   <label for="semester">Semester</label>
											   <select class="form-control" id="selectSemester" name="semester" required>
													   <option>Select Semester</option>
												</select>
											</div>
										</div>	
								
									<div class="col-md-3 pt-4 mt-2">
										<button  type="submit" class="btn btn-sm btn-info" id="btnView">View</button>	
									</div>
								
						
						  </div>
						  </form>
						</div>
					  </div>
					  <!-- /.col-md-12 -->
					</div>
					<!-- /.row -->
				  </div><!-- /.container-fluid -->
				</div>
				<!-- /.main content -->


				<!--Condonation list view -->
					<div class="row" id="condonationUpdate">
					<div class="col-md-12">	
						<div class="card">
							<div class="table-responsive">
							  <table id="tblCondonationUpdationList" class="table table-striped table-bordered  display" style="width:100%">
								<thead>
											<tr>
											   <th>Id</th>
											  <th>Student Id</th>	
											  <th>Student Name</th>						  
											  <th>Program / Batch / Semester</th>
											  <th>Attendance (%)</th>
											  <th>Status</th>
											  <th>Exempted</th>
											  <th>Payment Status</th>
											  <th>Actions</th>
											 </tr>
											</thead>
							  </table>
							</div>	
							
						</div>
					</div>
		
				</div>
				<!--Condonation list view -->
				
			<div class="row card " id="updateModel"  style="display:none;">
				<div class="col-md-12">
					<div class="description-block border-right">
					<h5 class="description-header">Condonation Verification and Approval  </h5>
					<hr>
					</div>
					</div>
					<div class="col-md-12">
						<div class="">
									<div class="row">
							    	<dl class="row pl-5">
									  <dt class="col-sm-4">Student Id</dt>
									  <dd class="col-sm-8" id="studentId"></dd>	
									  <dt class="col-sm-4" >Name</dt>
									  <dd class="col-sm-8" id="studentName"></dd>
									   <dt class="col-sm-4" >Program / Batch /Semester</dt>
									  <dd class="col-sm-8" id="programBatchSem"></dd>
									  <dt class="col-sm-4">Attendance (%) </dt>
									  <dd class="col-sm-8" id="attendance"></dd>
								      <dt class="col-sm-4">Previously any Condonation granted ?  (if yes, details) </dt>
								 	  <dd class="col-sm-8" id="previousExemption">--</dd>	
								 	  <dt class="col-sm-4">Reason for Absence </dt>
								 	  <dd class="col-sm-8" id="reason">---</dd>	
								 	  <dt class="col-sm-4">Supporting Documents </dt>
								 	  <dd class="col-sm-8" id="refDoc"></dd>	
								 	  <dt class="col-sm-4 link" style="display:none;">Submitted Document</dt>
								 	  <dd class="col-sm-8 link user-block"  style="display:none;">
									 	<a href="#" id="refDocLink"><img class=" img-bordered-sm" src="exam-management_proxy/exam-management_public/img/pdf.png" alt="user image"></a>
									  </dd>		
									  <dt class="col-sm-4">Status</dt>
								 	  <dd class="col-sm-1 right badge badge-danger" id="status" >----</dd>	
								    </dl>
									
								</div>	
								<div><hr></div>
								<form id="formUpdateCondonation">
								
									    <div class="row">
											<div class="form-group col-md-3 pl-5">
											   <label for="name">Exempted </label>
												<!-- <input checked="true" id="exempted"  type="checkbox" name="exempted"> -->
												<div class="row">
												<input id="exempted" name="exempted" type="checkbox"  data-on-text="Yes"   data-off-text="No" checked data-bootstrap-switch data-off-color="danger" data-on-color="success">
												</div>
											</div>
													
										
											<div class="form-group col-md-2">
											   <label for="name">Fine Amount</label>
											   <input type="text" class="form-control" placeholder="Enter Fine amount" name="fineAmount" id="fineAmount" disabled value=0 />
											</div>
											<div class="form-group col-md-1">
											   
											   
											</div>
									     <div class="form-group col-md-2 pt-4 mt-2">
								   			<button type="submit"  class="btn btn-sm btn-info" id="btnExempt"> Verify and Approve</button>
								   			</div>				
									</div>
								</form>
							</div>
						</div>
					</div>
				
	
	
	<div class="row card " id="viewModel" style="display:none;">
				<div class="col-md-12">
					<div class="description-block border-right">
					<h5 class="description-header">Condonation Details  </h5>
					<hr>
					</div>
					</div>
					<div class="col-md-12">
						<div class="">
									<div class="row">
							    	<dl class="row pl-5">
									  <dt class="col-sm-4">Student Id</dt>
									  <dd class="col-sm-8" id="studentViewId"></dd>	
									  <dt class="col-sm-4" >Name</dt>
									  <dd class="col-sm-8" id="studentViewName"></dd>
									   <dt class="col-sm-4" >Program / Batch /Semster</dt>
									  <dd class="col-sm-8" id="programBatchSemView"></dd>
									  <dt class="col-sm-4">Attendance (%) </dt>
									  <dd class="col-sm-8" id="attendanceView"></dd>
								      <dt class="col-sm-4">Previously any Condonation granted ?  (if yes, details) </dt>
								 	  <dd class="col-sm-8" id="previousExemptionView">--</dd>	
								 	  <dt class="col-sm-4">Reason for Absence </dt>
								 	  <dd class="col-sm-8" id="reasonView">---</dd>	
								 	  <dt class="col-sm-4">Supporting Documents </dt>
								 	  <dd class="col-sm-8" id="refDocView"></dd>	
								 	  <dt class="col-sm-4 link" style="display:none;">Submitted Document</dt>
								 	  <dd class="col-sm-8 link user-block"  style="display:none;">
									 	<a href="#"  id="refDocLink"><img class=" img-bordered-sm" src="exam-management_proxy/exam-management_public/img/pdf.png" alt="user image"></a>
									  </dd>
									  <dt class="col-sm-4">Exempted </dt>
								 	  <dd class="col-sm-8" id="exemptedView"></dd>	
								 	
								 	  <dt class="col-sm-4">FineAmount </dt>
								 	  <dd class="col-sm-8" id="fineAmountView"></dd>
								 	  	 	  	
								 	  <dt class="col-sm-4">Conondation  Status </dt>
								 	  <dd class="col-sm-8 " id="conStatus"  ></dd>
								 	  	
								 	  <dt class="col-sm-4">Payment Status </dt>
								 	  <dd class="col-sm-8" id="paymentStatus"></dd>
								 			
								    </dl>
									
								</div>	
								
																
																	
								   						
							
							</div>
						</div>
						
					</div>
	<div id="frameDoc" style="display:none;">
							        <iframe id="iframeDoc" height="500" width="100%"  title="Supporting document for condonation"></iframe>
							 </div>
	
<script>
//global variables and fns

/* base url for exam management */
var BASE_URL = "/exam-management/api/v1/";
var MARKS_CONFIG_URL = "/mark-config/api/v1/academics/marks-management/evaluation-types-program/program-id/";
var ACADEMIC_YEAR_URL = "/academics/api/v1/academics/getDetailsByMasterId/masterId/83";

	
	/* fn to convert form data to json */
	$.fn.serializeObject = function()
	{
	    var o = {};
	    var a = this.serializeArray();
	    $.each(a, function() {
	        if (o[this.name] !== undefined) {
	            if (!o[this.name].push) {
	                o[this.name] = [o[this.name]];
	            }
	            o[this.name].push(this.value || '');
	        } else {
	            o[this.name] = this.value || '';
	        }
	    });
	    return o;
	 };

 
 	$('.datepicker').datepicker({
	    //format: 'yyyy-mm-dd',	
 		//startDate : moment() , //0
	    format: 'dd-mm-yyyy',
		autoclose:true,
		clearBtn:true,
		pickerPosition: "bottom-left"
		
	});  
	
 	
	$('.datepicker-month-year').datepicker({
	    format: 'M-yyyy',	
	    startView: "months", 
        minViewMode: "months",						   
		autoclose:true,
		clearBtn:true
	});
	

    
    
    //getStudentInfo();
   	function getStudentInfo()
	{

      $.ajax({
	   		url: "/students/getStudentsDetails-V3",
	   		method: 'GET',
	   		data:{"userCodes":$("#usercode").val()},
	   		success: function(data)
	   		{
	   		  console.log(data);
	   		  return data;
	   		  	   			
	   		},
	   		error:function(err)
	   		{
	   			showMessage(err);
	   		}
	   	});
	 }
    
var selectedConfigArray=new Array();
//$(document).ready(function() {
	function getAllPrograms()
	{
	
		$.ajax({
	   		url:'/course/getAllCourses',
	   		method:'GET',
	   		success:function(data)
	   		{
	   		    setUpDropDown("selectProgram",data,"courseId","courseCode");
	   			$('#selectProgram').unbind().bind('change',function()
	   			{
	   				getAllActiveBatchesOfProgram($(this).val());
	   				loadEvaluationypes($(this).val());
	   			    if($("#displayTable").length){
	   				   $('#displayTable').empty();
	   			    }
	   			   if($(".configList").length){
	   				 
	   			    $('.configList').prop('checked', false);
	   			   }
	   			selectedConfigArray =[];
	   			
	   			});
	   		},
	   		error:function(err)
	   		{
	   			showMessage(err);
	   		}
	   	});
	}
	getAllPrograms();
	
    /* 
      To list the programs
	*/
	

	
	/**
	  To get all batches for the given programid
	*/
	 function getAllActiveBatchesOfProgram(programId)
	 {
	// $("#selectBatch").prop( "disabled", false );
		$.ajax(
		{
	  		url:'/batch/getAllActiveBatchesInAProgram',
	  	   	method:'GET',
	  	   	data:{"courseId":programId},
	  	   	success:function(data)
	  	   	{
	  	   	
	  	        setUpDropDown("selectBatch",data,"batchId","batchCode");
	  	   		$('#selectBatch').unbind().bind('change',function()
	   			{
	   				getAllActiveSemesterOfBatch($(this).val());
	   				
	   				
	   			});
	  	   		
	  	   	},
	  	   	error:function(err)
	  	   	{
	  	   		showMessage(err);
	  	   	}
	  	 });	  
	  }
	  
	  /**
	  To get all semesters the given batchid
	  */
	 function getAllActiveSemesterOfBatch(batchId)
	 {
		//$("#selectSemester").prop( "disabled", false );
		  $.ajax({
					"url" : "/batch/getAllSemestersInABatch",
					"method" : "GET",
					data : {"batchId":batchId},
					success :function(data) {
					console.log(data);
					    try{
						   if(data && data.length >0){
							   $('#selectSemester').empty();
							   $('#selectSemester').append('<option>Select Semester</option>');
							   for(var i=0;i< data.length;i++){
							   	   $("#selectSemester").append('<option value='+data[i]['semesterIdentity']['semesterCode']+'>'+data[i]['semesterIdentity']['semesterCode']+'</option>');
							   }
						 }
						}
						catch(e){
						    console.error(e);
						    showMessage(" Error occurred while processing semester list"); 
						}
													
						
					},
					error :function(e) {
					     showMessage(err);
					}
				});
		}
	 
	 function loadEvaluationypes(programId){
			$.ajax(
			{
				"url":MARKS_CONFIG_URL+programId,
				success:function(data)
				{
					types= data.data; 
					setUpDropDown("selectRevaluationType",types,"id","evaluationType");
				}
			});
		
		}
		
		/* load exam types */
		function loadExamTypes(){
			$.ajax(
			{
				"url":BASE_URL+"exam-management/exam-types",
				success:function(data)
				{
					types= data.data; 
					setUpDropDown("selectExamType",types,"id","type");
				}
			});
		
		}
		
		/* load academic year from look  up */
		function loadAcademicYear(){
			$.ajax(
			{
				"url": ACADEMIC_YEAR_URL ,//"/academics/api/v1/academics/getDetailsByMasterId/masterId/83",
			//	"url":"/nualsTest/api/v1/academics/getDetailsByMasterId/masterId/83",
				success:function(data)
				{
					 
					setUpDropDown("selectAcademicYear",data,"id","detailName");
				}
			});
		
		}
	 
		
//});
$(document).ready(function() {
 
	$("#condonationUpdate").hide();
   $("#viewModel").hide();
   $("#updateModel").hide();
   
   $('#exempted').prop('checked', true);
       var condonationListDataTable;
       
   var exemption = false;
   var feeAmount;
   var studentId;
   var docLink;
   var processId;
   var condonationId;
    var datawithPayment =[];
   getCondonationProcessId();
   
   $("input[data-bootstrap-switch]").each(function() {
			$(this).bootstrapSwitch('state',
					$(this).prop('checked'));
		});
							
	function getCondonationProcessId(){
	
	
		 $.ajax({
		      	 "url":"/fees/getFeeHeadByProcessCode",
	               data:{"ProcessCode":'condonationFee'},
		   		//method: 'POST',
		   		contentType: "application/json",
		   		success: function(data)
		   		{
		   		  //  showMessage("Generated Condonation list Successfully");
		   	          processId = data.sfsFeeHeadId;
		   	
		   	
		   		  	   		  	   			
		   		},
		   		error:function(err)
		   		{
		   		    toastr.error("Condonation config failed");
		   			//showMessage(err);
		   		}
		   	});	  
	
	
	}
	
	/**
	 * Get condonation Fee amount for the given feeheadId
	 */
	function getCondonationFee(feeHeadId, programId) {
	console.log(programId);

		$
				.ajax({
					url : '/fees/getFeeDetailsByExaminationFeeHeadsAndCourse',
					method : 'GET',
					
					data : {
						"feeHeadId" : feeHeadId,
						"courseId" : programId
					},
					success : function(data) {
						console.log(data.feeAmount);
					if(data){
						 feeAmount = data.feeAmount;
						 console.log(feeAmount);
						 //return feeAmount;
                          $("#fineAmount").val(feeAmount);
                         }
                        else{
                        	toastr.error("condonation Fee amount is not set for this Program !!!");
                        
                        } 
					},
					error : function(err) {
						toastr
								.error("Failed to load Fee details");
					}
				});
		

	}						
							
  
   
    /**
	 Generate condonation list 
	**/
    $("#formCondonationList").submit(function (event) {
         event.preventDefault();
           $("#condonationUpdate").show();
       //    $("#viewModel").show();
        //   $("#updateModel").show();
	   	  //  loadCondonationList();
	   		  	   			
	   	 var url = BASE_URL+"condonation/list";
	   	 var data = {"programId":$('#selectProgram').val(),"batchId":$('#selectBatch').val(),"semester":$('#selectSemester').val()};
         var datawithPayment =  loadURLData(url,data);
         loadCondonationList(datawithPayment);
         getCondonationFee(processId,$( "#selectProgram option:selected" ).val());
	   //	alert(processId,$('#selectProgram').val());
            
    });
    
    
   /*
   *  Function to load the condonation list which satisfies the criteria 
   */
   function loadCondonationList(data){ 
	   console.log("data in data table ");
	   console.log( data);
       condonationListDataTable =  $('#tblCondonationUpdationList').DataTable({
            "language": {
                    "emptyTable": "No students found satisfying your criteria"
                  },
			"processing": true,
			"destroy": true,
			"data":data,
			"columns": [
			
		    { "data": "id"},
			{ "data": "studentId"},
			{ "data": "studentName" },
			{ "data": "null",
			            "render": function (data, type, full, meta) {
		            
		                    return (full.program + " / " + full.batch + " / " + full.semester)   
			            }
		      },
			{ "data": "percentage" },
			{ "data": "status","render": function (data, type, full, meta) {
						              if(data ==null)
						                   return ("Listed");
						               else
						                 return data;
						                       
						            }},
			{ "data": "exempted","render": function (data, type, full, meta) {
	              if(data ==null)
	                   return ("---");
	               else
	            	   return (data ? "YES" : "NO");  
	            	   
	                       
	            }},
			{ "data": "feeOrderStatusValue",
						"render": function (data, type, full, meta) {
						              if(data ==null)
						                   return ("---");
						               else
						                return data;       
						            }},
			
			{
				"data": null,
				"render":function (data, type, full, meta) {
					if(data.fineAmount == null)
					    return '<a data-toggle="collapse" href="#"  class=""small-box-footer text-danger" id="btnEdit"> <i class="fas fa-edit"></i></a>';
					else
					  return '<a data-toggle="collapse" href="#"  class=""small-box-footer text-danger" id="btnView"> <i class="fas fa-eye"></i></a>';
					   
					}
			}
			],
		"columnDefs": [
            {
                "targets": [ 0 ],
                "visible": false,
                "searchable": false
            }
            ]
		});
   
     $('#tblCondonationUpdationList tbody').on( 'click', 'tr', function () {
	
	        if ( $(this).hasClass('selected') ) {
	            $(this).removeClass('selected');
	        }
	        else {
	            condonationListDataTable.$('tr.selected').removeClass('selected');
	            $(this).addClass('selected');
	        }
	    } );
	    
	    
    
	   /*
	   *  Action function to update the condonation list 
	   */
	    $('#tblCondonationUpdationList tbody').on('click', '#btnEdit', function () {
	            	             
	    	  $('#frameDoc').hide();
	           	$('#viewModel').hide();            
	    	    $('#updateModel').show();
	            $('#id').hide();
	    
			    $('html, body').animate({
				        scrollTop: $("#updateModel").offset().top
				}, 1000);
				
				
	            var data = condonationListDataTable.row($(this).parents('tr')).data();
              	         	
                 condonationId = data.id;
                 studentId = data.studentId;
               	$("#studentId").text(data.studentId);
              	$("#studentName").text(data.studentName);
              	$("#attendance").text(data.percentage);
              	$("#programBatchSem").text(data.program + " / " + data.batch + " / " + data.semester);

              	let exemptionString;
              	/* exemption */
                for(var i = 0; i < datawithPayment.length; i++){

				   if(datawithPayment[i].hasOwnProperty('exempted') && datawithPayment[i]['exempted'] === true && datawithPayment[i]['studentId'] === data.studentId) {
				    exemptionString = exemptionString + datawithPayment[i]['program'] + "/"+ datawithPayment[i]['batch'] +"/"+ datawithPayment[i]['semester'];
				   }

              }
               	$("#previousExemption").text(exemptionString);
               	if(data.reason != null)
               		$("#reason").text(data.reason);
               	if(data.refDoc != null)
				 {
				   $('#refDoc').text('Yes');
				   //$('#refDocView').hide;
				    $('.link').show();
				    //docLink = data.refDoc;
				    docLink = "filerepo_public/minioFiles/nuals/"+data.refDoc;  
				      
				 }
				 else{
				   $('#refDoc').text('No');
				    $('.link').hide();
				    }
				   
               	if(data.status  == null){
             
               	$("#status").text( "Listed");
               	}
              		 
              	else
              	 $("#status").text(data.status ? data.status : "Listed"  );
               	
              	/* exemption */
              
              	if(data.exempted != null)
              	  $("#exempted").bootstrapSwitch('state',data.exempted);
              	else
              	  $("#exempted").bootstrapSwitch('state', false);
              	  
              	/* fine amount */  
              	if(data.fineAmount != null)
                 	$("#fineAmount").val(data.fineAmount);
                 else
                    $("#fineAmount").val(feeAmount);
                 
           
	                $("#btnUpdate").show();
		});
		
		
	
	   /*
	   *  Action function to update the condonation list 
	   */
	    $('#tblCondonationUpdationList tbody').on('click', '#btnView', function () {
	            	             
	    	$('#frameDoc').hide();               	                     
	    	    $('#viewModel').show();
	            $('#updateModel').hide();  
			    $('html, body').animate({
				        scrollTop: $("#viewModel").offset().top
				}, 1000);
				
				var data = condonationListDataTable.row($(this).parents('tr')).data();
              	console.log(data);
              	              
               	$("#studentViewId").text(data.studentId);
              	$("#studentViewName").text(data.studentName);
              	$("#attendanceView").text(data.percentage);
              	$("#programBatchSemView").text(data.program + " / " + data.batch + " / " + data.semester);
              	
              	let exemptionString;
              	/* exemption */
                for(var i = 0; i < datawithPayment.length; i++){

				   if(datawithPayment[i].hasOwnProperty('exempted') && datawithPayment[i]['exempted'] === true && datawithPayment[i]['studentId'] === data.studentId) {
				    exemptionString = exemptionString + datawithPayment[i]['program'] + "/"+ datawithPayment[i]['batch'] +"/"+ datawithPayment[i]['semester'];
				   }

              }
               	$("#previousExemptionView").text(exemptionString);
               	$("#reasonView").text(data.reason ? data.reason : "----");
               	if(data.refDoc != null)
				 {
				   $('#refDocView').text('Yes');
				   //$('#refDocView').hide;
				    $('.link').show();
				    docLink = "filerepo_public/minioFiles/nuals/"+data.refDoc;    
				 }
				 else
				   $('#refDocView').text('No');
				   
                 $("#exemptedView").text(data.exempted ? "YES" : "NO");    	  
              	/* fine amount */  
              	 $("#fineAmountView").text(data.fineAmount);
              	 
              	 if(data.status  ==null)
              		$("#conStatus").text( "Listed"); 
              	else
              	 $("#conStatus").text(data.status ? data.status : "Listed"  );
              
              	$("#paymentStatus").text(data.feeOrderStatusValue ? data.feeOrderStatusValue :"Fine not generated" );
                
		});
		
	
	}
	
	$("#refDocLink").on('click',function(){
			  //window.open(docLink, '_blank');
			  $('#frameDoc').show();
			  $('html, body').animate({
			        scrollTop: $("#frameDoc").offset().top
			}, 1000);
			  $('#iframeDoc').attr('src', docLink);
		})
	
			
			
			
	/**
	 * change event of no due certificate switch
	 */
	$("input[data-bootstrap-switch]").on(
			'switchChange.bootstrapSwitch',
			function(event, state) {
				
				$("#fineAmount").prop('disabled', true);
				if (state === true) {
					exemption = true;
					$("#fineAmount").val(0);
					 
				} else {
				 
				exemption = false;
				$("#fineAmount").val(feeAmount);
					
				}

			});
			
							
    /**
	 * update condonation fee details and raise fine amount as debit against the student 
	**/
	
   	$('#formUpdateCondonation').unbind().bind('submit',function(event)
	{
	
		 event.preventDefault();
				
		 // serialize the form
		 condonationFormData = {};
	     condonationFormData.exempted= exemption;
	     condonationFormData.id=condonationId; 
	     condonationFormData.fineAmount = feeAmount ? feeAmount : 0 ;
	        condonationFormData.status = "APPROVED";
        
	      if(condonationFormData.fineAmount > 0 ){
	             var timestamp = Number(new Date()); 
			      var orderId = "CONDONATION-"+studentId+"-"+timestamp;
			      condonationFormData.orderId= orderId; 	 
		     }   
	      else
	    	  condonationFormData.orderId= null; 	
	      
	     condonationFormDataJson = JSON.stringify(condonationFormData);
		  
		 var msg = {
					 title : "Approve",
					 msg : " Do you want to approve condonation?"
				   }
		 ConfirmDialog(msg, "APPROVE").then(function(response) {
		
		 			debitFee(condonationFormDataJson,condonationFormData.orderId);
									
		  }, function(error) {
				
				  toastr.error("Approval cancelled");	
			
			});
				          
	
     });
    
    
    /**
    * debit fee against the student
    */
    
    function debitFee(condonationFormDataJson,orderId)
    {
    	
    	  if($("#fineAmount").val() > 0 && exemption == false)
		  {
		    		  
    		var map={};
            var formData = [];
		  	map['transactionIdentifierRemarkOrProcess'] = orderId;
			map['transactionIdentifierProcessId'] = processId; // TO-DO
			map['transactionAmount']=$("#fineAmount").val();
			map['studentUserCode'] =  studentId;
			formData.push(map);
	        console.log(formData);
	        
		    $.ajax({
		           type: "POST",
		           async:false,
		            url: "/fees/generateFeeDebitsV1-v1",
		            data:{"transactionWrappers":formData},
						   
		            success: function(data)
		           {
					//showMessage("Fee Debit done Successfully !! . Kindly pay the fees at the fee section ");
					toastr.success("Fee debited against the student");
					
		           } ,
			   		error:function(err)
			   		{
			   		    toastr.error("Fee Debit  failed");
			   			//showMessage(err);
			   		}
			 });
	         
		  }
    	
		  
		  updateCondonation(condonationFormDataJson);
    
    
    }
    
    
    /* 
    *  update on change of amount and exemption
    */
    function updateCondonation(condonationFormDataJson)
    {
       console.log("condonationFormDataJson"+condonationFormDataJson);
      
	     $.ajax({
	   		url: BASE_URL+"condonation/update",
	   		method: 'POST',
	   	
	   		data:condonationFormDataJson,
	   		contentType: "application/json",
	   		success: function(data)
	   		{
	   		  //  showMessage("Generated Condonation list Successfully");
	   		   $('#updateModel').hide();
	   		   toastr.success("Condonation details updated");
	   		   reloadTable();
	   		  	   		  	   			
	   		},
	   		error:function(err)
	   		{
	   		    toastr.error("Condonation Updation failed");
	   			//showMessage(err);
	   		}
	   	});	  
	   	
    }
    
    /**
    *  reload data after successful updation
    */
    
    function reloadTable()
    {
    	 var url = BASE_URL+"condonation/list";
	   	 var data = {"programId":$('#selectProgram').val(),"batchId":$('#selectBatch').val(),"semester":$('#selectSemester').val()};
          datawithPayment =  loadURLData(url,data);
         loadCondonationList(datawithPayment);
    
    }
   
    
  });       


   /**
   * Fee Settings
   */
   
   var studentListWithData=new Array();
   var studentCodeList=new Array();
   
   
	function loadData(url)
	{
		let dataWithPayment=[];
		$.ajax(
		{
			url:url,
			async:false,
			success:function(data)
			{
			studentListWithData=data.data;
			console.log(studentListWithData);
			if(studentListWithData.length>0){
			  var studfeeidmapArray=generateFeeIdenMapArray(studentListWithData);
			  console.log(studfeeidmapArray);
			  dataWithPayment = getFeeOrderStatus(studfeeidmapArray);
			}
		}
	})
	
	return dataWithPayment;
  }
  
  function loadURLData(url,data)
	{
		let dataWithPayment=[];
		$.ajax(
		{
			url:url,
			method:"POST",
			data:data,
			async:false,
			success:function(data)
			{
			studentListWithData=data.data;
			console.log(studentListWithData);
			if(studentListWithData.length>0){
			  var studfeeidmapArray=generateFeeIdenMapArray(studentListWithData);
			  console.log(studfeeidmapArray);
			  dataWithPayment = getFeeOrderStatus(studfeeidmapArray);
			}
		}
	})
	
	return dataWithPayment;
  }
	
 function generateFeeIdenMapArray(data)
	{
		var mapArray=new Array();
		for(let i=0;i<data.length;i++)
		{
			var map={};
			var studCode=data[i]['studentId'];
			map['feeOrderStudent']=studCode;//maintain the same key feeOrderStudent in map
			//if(data[i]['orderId'] != null)
			 map['feeOrderIdentity']= data[i]['orderId'];//maintain the same key feeOrderIdentity in map
			//else 
			// map['feeOrderIdentity']= "";//maintain the same key feeOrderIdentity in map
			
			mapArray.push(map);
			}
			return mapArray;
	}

 function addTostudentListWithData(data)
	{
		for(let i=0;i<studentListWithData.length;i++)
		{
		for(let j=0;j<data.length;j++)
		{
		//if(String(studentListWithData[i]['studentId'])==data[j]['feeOrderStudentCode'])
		if(String(studentListWithData[i]['orderId'])==data[j]['feeOrderId'])
		{
		studentListWithData[i]['feeOrderStatusValue']=data[j]['feeOrderStatusValue'];
		}
		if(String(studentListWithData[i]['orderId'])== null){
		
			studentListWithData[i]['feeOrderStatusValue']= "No Fee";
		  }
		  
		}
	}
	
	}
	
	
 function getFeeOrderStatus(datatosend)
	{
		console.log("calling getFeeOrderStatus function")
		$.ajax(
		{
			   url:'/fees/getManyFeeOrderStatusByFeeIdentifierAndAccount',
			   data:{'feeOrderStudents':datatosend},
			   method:"post",
			   async:false,
			   success:function(data)
			   {
					console.log(data); 
					if(data.length>0)
					{
					addTostudentListWithData(data);
					//loadDatatable(studentListWithData);
					//return studentListWithData;
					}
	           },
		    error:function(err)
				{
				showMessage(err);
				}
		});
		return studentListWithData;
}
   var ConfirmDialog = function (data,type){

 var TYPE;
 var ICON ;
 var BTN_CLASS;

	 if ( type == 'SAVE'){
		 TYPE = 'green';
		 ICON =  'fa fa-save';
		 BTN_CLASS = 'btn-success';
	 }
	 else if ( type == 'DELETE'){
		 TYPE = 'red';
		 ICON =  'fa fa-trash';
		 BTN_CLASS = 'btn-danger';	 
	 }
	 else if ( type == 'APPROVE'){
		 TYPE = 'red';
		 ICON =  'fa fa-thumbs-up';
		 BTN_CLASS = 'btn-danger';	 
	 }
	 else
	 {
		 TYPE = 'red';
		 ICON =  'fa fa-warning';
		 BTN_CLASS = 'btn-warning';	
	 }
	 var DialogPromise = function (resolve, reject) {
	    
	     $.confirm({
	        title: data.title,
	        content:data.msg,
	        closeIcon : true,
	        type: TYPE,
	        icon: ICON,
	        offsetTop: 40,	      
	        bgOpacity :'0.7',
	        buttons: {  
	            ok: {
	                text: "<b> Yes </b>",	            
	                keys: ['enter'],
	                action: function(){	                    
	                     resolve(true); 	                    
	                }
	            },
	            no: function(){
	              text: "<b> No </b>",	                  
	                    reject(false); 
	            }
	        }
     });    
    
   };    
    return  new  Promise (DialogPromise);
 }
</script>  

	
	
	
	
	